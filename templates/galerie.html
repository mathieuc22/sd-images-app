{% include 'header.html' %}

<div class="gallery">
  {% for image in images|sort(attribute='path') %}
  <div class="card">
    <img src="{{ url_for('static', filename=image.thumbnail) }}" />
    <button class="like-btn" data-image-id="{{ image.id }}">
      {% if image.liked %} Unlike {% else %} Like {% endif %}
    </button>
    <button class="delete-btn" data-image-id="{{ image.id }}">Delete</button>
    <div class="card-content">
      <p><strong>File:</strong> {{ image.path.split('/')[-1] }}</p>
      <p>
        <strong>Parameters:</strong> {{ image.parameters|truncate(80, end='...')
        }}
      </p>
      {% if image.steps %}
      <p><strong>Steps:</strong> {{ image.steps }}</p>
      {% endif %} {% if image.sampler %}
      <p><strong>Sampler:</strong> {{ image.sampler }}</p>
      {% endif %} {% if image.cfg_scale %}
      <p><strong>CFG Scale:</strong> {{ image.cfg_scale }}</p>
      {% endif %} {% if image.seed %}
      <p><strong>Seed:</strong> {{ image.seed }}</p>
      {% endif %} {% if image.size %}
      <p><strong>Size:</strong> {{ image.size }}</p>
      {% endif %} {% if image.model_hash %}
      <p><strong>Model Hash:</strong> {{ image.model_hash }}</p>
      {% endif %} {% if image.model %}
      <p><strong>Model:</strong> {{ image.model }}</p>
      {% endif %}
    </div>
  </div>
  {% endfor %}
</div>

<script>
  window.addEventListener("DOMContentLoaded", (event) => {
    const likeButtons = document.querySelectorAll(".like-btn");
    likeButtons.forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const imageId = e.target.getAttribute("data-image-id");
        const isLiked = e.target.textContent.trim().toLowerCase() === "unlike";
        const url = isLiked
          ? `/unlike-image/${imageId}`
          : `/like-image/${imageId}`;

        fetch(url, { method: "POST" })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              // Update the like button text
              e.target.textContent = isLiked ? "Like" : "Unlike";
            } else {
              // Handle error
              console.error("Failed to like/unlike image:", data.error);
            }
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      });
    });
    const deleteButtons = document.querySelectorAll(".delete-btn");
    deleteButtons.forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const imageId = e.target.getAttribute("data-image-id");
        fetch(`/delete-image/${imageId}`, {
          method: "DELETE",
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              // Optionally remove the image from the UI
              e.target.parentElement.remove();
            } else {
              // Handle error
              console.error("Failed to delete image:", data.error);
            }
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      });
    });
  });
</script>
